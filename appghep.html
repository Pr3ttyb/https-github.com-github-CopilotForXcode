<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>ƒê·∫∑t xe tuy·∫øn c·ªë ƒë·ªãnh</title>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet"/>
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
    }
    #map {
      height: 70vh;
      width: 100%;
    }
    .controls {
      padding: 15px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 0 auto;
      border-radius: 8px;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #4a90e2;
      outline: none;
    }
    button {
      background-color: #4a90e2;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      margin-top: 10px;
    }
    button:hover {
      background-color: #3a7bc8;
    }
    #geocoder-start, #geocoder-end {
      margin: 10px 0;
    }
    #captcha-container {
      margin: 15px 0;
      display: none;
    }
    .location-btn {
      background-color: #f5f5f5;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
    }
    .location-btn:hover {
      background-color: #e0e0e0;
    }
    .required:after {
      content: " *";
      color: red;
    }
    @media (max-width: 768px) {
      .controls {
        padding: 10px;
      }
      input, select, textarea, button {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="controls">
    <div class="form-group">
      <label for="name" class="required">H·ªç t√™n</label>
      <input id="name" placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß"/>
    </div>
    
    <div class="form-group">
      <label for="phone" class="required">S·ªë ƒëi·ªán tho·∫°i</label>
      <input id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" type="tel"/>
    </div>
    
    <div class="form-group">
      <label for="carType" class="required">Lo·∫°i xe</label>
      <select id="carType">
        <option value="Xe gh√©p">Xe gh√©p (chia s·∫ª chuy·∫øn)</option>
        <option value="Xe ri√™ng">Xe ri√™ng</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="datetime" class="required">Ng√†y & gi·ªù</label>
      <input id="datetime" placeholder="Ch·ªçn ng√†y v√† gi·ªù..."/>
    </div>
    
    <div class="form-group">
      <label for="geocoder-start" class="required">ƒêi·ªÉm ƒë√≥n</label>
      <div id="geocoder-start"></div>
    </div>
    
    <div class="form-group">
      <label for="geocoder-end" class="required">ƒêi·ªÉm ƒë·∫øn</label>
      <div id="geocoder-end"></div>
    </div>
    
    <button class="location-btn" onclick="goToCurrentLocation()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
        <circle cx="12" cy="10" r="3"></circle>
      </svg>
      L·∫•y v·ªã tr√≠ hi·ªán t·∫°i
    </button>
    
    <div class="form-group">
      <label for="refCode">M√£ gi·ªõi thi·ªáu (n·∫øu c√≥)</label>
      <input id="refCode" placeholder="Nh·∫≠p m√£ gi·ªõi thi·ªáu"/>
    </div>
    
    <div class="form-group">
      <label for="note">Ghi ch√∫</label>
      <textarea id="note" placeholder="S·ªë gh·∫ø, s·ªë nh√†, h√†ng h√≥a... (kh√¥ng b·∫Øt bu·ªôc)" rows="3"></textarea>
    </div>
    
    <div id="captcha-container">
      <div class="g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"></div>
    </div>
    
    <button onclick="sendInfo()">G·ª≠i th√¥ng tin ƒë·∫∑t xe üöñ</button>
  </div>
  
  <div id="map"></div>

  <!-- Scripts -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
  <script async defer src="https://www.google.com/recaptcha/api.js"></script>
  
  <script>
    // Kh·ªüi t·∫°o bi·∫øn to√†n c·ª•c
    let pickup = null, dropoff = null;
    let pickupAddress = '', dropoffAddress = '';
    let pickupMarker = null, dropoffMarker = null;
    let submitCount = 0;
    let map, pickupGeocoder, dropoffGeocoder;
    
    // H·∫±ng s·ªë c·∫•u h√¨nh v·ªõi API key m·ªõi
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiYXR0b25nMzkiLCJhIjoiY204bjVoazYxMWp2djJtcXJ1OHdzeHVyciJ9.T4c11fBbmCg8GIMU70BrpQ';
    const BBOX_NORTH_VN = [102.14441, 19.0, 107.7, 23.5];
    const TELEGRAM_BOT_TOKEN = '7947843146:AAHjxlQcTS9d4vdOQ-9pzS_NZdF_iFjI0MU';
    const TELEGRAM_CHAT_ID = '7311822484';
    
    // Kh·ªüi t·∫°o ·ª©ng d·ª•ng khi DOM s·∫µn s√†ng
    document.addEventListener('DOMContentLoaded', function() {
      initDateTimePicker();
      initMap();
      initGeocoders();
    });
    
    function initDateTimePicker() {
      flatpickr("#datetime", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        minDate: "today",
        time_24hr: true,
        locale: "vn",
        minuteIncrement: 5,
        defaultHour: 7,
        defaultMinute: 0
      });
    }
    
    function initMap() {
      mapboxgl.accessToken = MAPBOX_TOKEN;
      
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [105.8542, 21.0285], // H√† N·ªôi
        zoom: 10
      });
      
      // Th√™m ƒëi·ªÅu khi·ªÉn zoom v√† compass
      map.addControl(new mapboxgl.NavigationControl());
    }
    
    function initGeocoders() {
      pickupGeocoder = new MapboxGeocoder({
        accessToken: MAPBOX_TOKEN,
        placeholder: "Nh·∫≠p ƒë·ªãa ch·ªâ ƒë√≥n...",
        mapboxgl: mapboxgl,
        bbox: BBOX_NORTH_VN,
        proximity: { longitude: 105.8542, latitude: 21.0285 },
        language: 'vi'
      });
      
      dropoffGeocoder = new MapboxGeocoder({
        accessToken: MAPBOX_TOKEN,
        placeholder: "Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫øn...",
        mapboxgl: mapboxgl,
        bbox: BBOX_NORTH_VN,
        proximity: { longitude: 105.8542, latitude: 21.0285 },
        language: 'vi'
      });
      
      document.getElementById('geocoder-start').appendChild(pickupGeocoder.onAdd(map));
      document.getElementById('geocoder-end').appendChild(dropoffGeocoder.onAdd(map));
      
      // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn ƒëi·ªÉm ƒë√≥n
      pickupGeocoder.on('result', function(e) {
        pickup = e.result.center;
        pickupAddress = e.result.place_name;
        updateMarker('pickup', pickup, 'green');
        zoomToMarkers();
      });
      
      // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn ƒëi·ªÉm ƒë·∫øn
      dropoffGeocoder.on('result', function(e) {
        dropoff = e.result.center;
        dropoffAddress = e.result.place_name;
        updateMarker('dropoff', dropoff, 'blue');
        zoomToMarkers();
      });
    }
    
    function updateMarker(type, coordinates, color) {
      if (type === 'pickup') {
        if (pickupMarker) pickupMarker.remove();
        pickupMarker = new mapboxgl.Marker({ color: color })
          .setLngLat(coordinates)
          .setPopup(new mapboxgl.Popup().setHTML(`<b>ƒêi·ªÉm ƒë√≥n:</b><br>${pickupAddress}`))
          .addTo(map);
      } else {
        if (dropoffMarker) dropoffMarker.remove();
        dropoffMarker = new mapboxgl.Marker({ color: color })
          .setLngLat(coordinates)
          .setPopup(new mapboxgl.Popup().setHTML(`<b>ƒêi·ªÉm ƒë·∫øn:</b><br>${dropoffAddress}`))
          .addTo(map);
      }
    }
    
    function zoomToMarkers() {
      if (pickup && dropoff) {
        const bounds = new mapboxgl.LngLatBounds();
        bounds.extend(pickup);
        bounds.extend(dropoff);
        map.fitBounds(bounds, { padding: 100, maxZoom: 14 });
      } else if (pickup) {
        map.flyTo({ center: pickup, zoom: 14 });
      } else if (dropoff) {
        map.flyTo({ center: dropoff, zoom: 14 });
      }
    }
    
    function goToCurrentLocation() {
      if (!navigator.geolocation) {
        alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const lng = position.coords.longitude;
          const lat = position.coords.latitude;
          const userLocation = [lng, lat];
          
          // Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·∫øn v·ªã tr√≠ hi·ªán t·∫°i
          map.flyTo({ center: userLocation, zoom: 14 });
          
          // Th√™m marker v·ªã tr√≠ hi·ªán t·∫°i
          new mapboxgl.Marker({ color: 'red' })
            .setLngLat(userLocation)
            .setPopup(new mapboxgl.Popup().setHTML("<b>V·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n</b>"))
            .addTo(map);
            
          // L·∫•y ƒë·ªãa ch·ªâ t·ª´ t·ªça ƒë·ªô
          fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}&language=vi`)
            .then(response => response.json())
            .then(data => {
              if (data.features && data.features.length > 0) {
                const address = data.features[0].place_name;
                // T·ª± ƒë·ªông ƒëi·ªÅn v√†o √¥ ƒëi·ªÉm ƒë√≥n
                pickupGeocoder.query(address);
              }
            });
        },
        function(error) {
          let errorMessage = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i.";
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = "B·∫°n ƒë√£ t·ª´ ch·ªëi y√™u c·∫ßu ƒë·ªãnh v·ªã. Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.";
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = "Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng.";
              break;
            case error.TIMEOUT:
              errorMessage = "Y√™u c·∫ßu l·∫•y v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian ch·ªù.";
              break;
          }
          alert(errorMessage);
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }
    
    function validatePhoneNumber(phone) {
      const regex = /^(0|\+84)(3[2-9]|5[2689]|7[06-9]|8[1-9]|9[0-9])[0-9]{7}$/;
      return regex.test(phone);
    }
    
    function sendInfo() {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const carType = document.getElementById("carType").value;
      const datetime = document.getElementById("datetime").value.trim();
      const refCode = document.getElementById("refCode").value.trim();
      const note = document.getElementById("note").value.trim();
      
      // Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
      if (!name || !phone || !datetime || !pickup || !dropoff) {
        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c th√¥ng tin b·∫Øt bu·ªôc (*)");
        return;
      }
      
      if (!validatePhoneNumber(phone)) {
        alert("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam.");
        return;
      }
      
      // Ki·ªÉm tra captcha sau 3 l·∫ßn g·ª≠i
      submitCount++;
      if (submitCount >= 3) {
        const captchaContainer = document.getElementById("captcha-container");
        captchaContainer.style.display = "block";
        const response = grecaptcha.getResponse();
        if (!response) {
          alert("Vui l√≤ng x√°c minh b·∫°n kh√¥ng ph·∫£i l√† robot tr∆∞·ªõc khi g·ª≠i.");
          return;
        }
      }
      
      // T·∫°o URL ch·ªâ ƒë∆∞·ªùng Google Maps
      const googleMapsUrl = `https://www.google.com/maps/dir/${pickup[1]},${pickup[0]}/${dropoff[1]},${dropoff[0]}`;
      
      // G·ª≠i th√¥ng tin ƒë·∫øn Telegram
      fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: `üÜï *TH√îNG TIN ƒê·∫∂T XE M·ªöI*\n
üë§ *T√™n kh√°ch:* ${name}
üìû *SƒêT:* [${phone.substring(0, 3)}****${phone.substring(7)}]
üöó *Lo·∫°i xe:* ${carType}
üìÖ *Th·ªùi gian:* ${datetime}
üìç *ƒêi·ªÉm ƒë√≥n:* ${pickupAddress}
üèÅ *ƒêi·ªÉm ƒë·∫øn:* ${dropoffAddress}
üó∫Ô∏è *Ch·ªâ ƒë∆∞·ªùng:* [Xem tr√™n b·∫£n ƒë·ªì](${googleMapsUrl})
üìù *Ghi ch√∫:* ${note || "Kh√¥ng c√≥"}
üîó *M√£ gi·ªõi thi·ªáu:* ${refCode || "Kh√¥ng c√≥"}`,
          parse_mode: "Markdown",
          disable_web_page_preview: false
        })
      })
      .then(response => {
        if (response.ok) {
          alert("‚úÖ Th√¥ng tin ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!\nT√†i x·∫ø s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm.");
          // Reset form sau khi g·ª≠i th√†nh c√¥ng
          document.getElementById("name").value = "";
          document.getElementById("phone").value = "";
          document.getElementById("datetime").value = "";
          document.getElementById("refCode").value = "";
          document.getElementById("note").value = "";
          if (pickupMarker) pickupMarker.remove();
          if (dropoffMarker) dropoffMarker.remove();
          pickup = null;
          dropoff = null;
          pickupAddress = '';
          dropoffAddress = '';
          grecaptcha.reset();
          document.getElementById("captcha-container").style.display = "none";
        } else  
